## TCP连接

> 互联网，实际上是一套理念和协议组成的体系架构，其中，协议则是一套众所周知的规则和标准，如果各方都同意使用，那么它们之间的通信将变得毫无障碍。互联网中的数据是通过包的形式来进行传输的，如果数据很大，就会拆分成很多小的数据包，比如音频视频数据，都是拆分后运输的结果

我们将互联网比作社会，计算机代表我们每个人，计算机之间的通信就是人与人之间的交流。每个计算机都有一个独一无二的IP地址，这就是我们每个人的地理位置。我们已知对方的地址，然后再选择一个协议即通信方式（电话/邮件/qq...）

我们来看一下一个数据包从主机A到主机B的旅程

* 上层将数据包交给网络层
* 网络层将IP头附在数据包上，组成新的IP数据包，并且交给底层
* 底层通过物理网络将数据包传输给主机B
* 数据包传输到了主机B的网路层，在这里主机B拆开数据包的IP头信息，并将拆开的数据部分交给上层
* 主机B上层收到

> IP是非常底层的协议，只负责将数据包传送给对方的电脑，但是此时对方电脑并不知道将数据包交给哪个程序，是给浏览器还是steam？我们需要一个传输层的协议，最常见的是UDP和TCP

UDP和TCP这类传输层协议最重要的是端口号，每个想要访问网络的程序都需要绑定一个端口号，IP协议将数据包发送到主机后，再通过应用层协议来将数据包分发给正确的程序

UDP相比TCP协议，发包速度更快，但是丢包率更大，它会应用于一些关注速度，不那么严格要求数据完整性的领域，比如在线视频

TCP协议的特点

* 丢包提供重传机制
* 引入了数据包排序机制，保证乱序数据可以组合成一个完整的文件
* 牺牲了传输速度，保证了数据传输的可靠性

一个完整的TCP连接的生命周期包括，建立连接，传输数据，和断开连接三个阶段

建立连接阶段，这个阶段是通过三次握手来建立。传输数据阶段，接收端需要对每个数据包进行确认操作，也就是接收端在接收到数据包之后，需要发送确认数据包给发送端。最后的断开连接有四次挥手的操作

## HTTP协议

TCP和UDP都属于传输层的协议，而HTTP协议则属于应用层，它是TCP协议的上层。请求方要发送的数据包，在应用层加上HTTP头之后会交给传输层的TCP协议处理，应答方接收到的数据包，在传输层拆掉TCP头之后交给应用层的HTTP协议处理

HTTP是一种基于TCP连接基础之上，允许浏览器向服务器获取资源的协议，是Web的基础

### 浏览器端发起HTTP请求的流程

* 构建请求
* 查找缓存，如果本地存在缓存则拦截该请求，返回该资源的副本，并直接结束请求，不会去源服务器重新下载
* 准备IP地址和端口。因为HTTP协议作为应用层协议，用来封装请求的文本信息，在HTTP工作开始之前，浏览器需要通过TCP与服务器建立链接，也就是说HTTP的内容是通过TCP的传输数据阶段来实现的
    * 请求DNS返回域名对应的IP/查询DNS缓存
    * 利用IP地址和端口号和服务器建立TCP连接
* 等待TCP队列。chrome有一个机制，同一个域名最多只能建立6个TCP连接，如果一个域名下同时有10个请求发生，那么其中4个请求会进入排队等待状态，直至进行中的请求完成
* 发送HTTP请求。浏览器向服务器发送请求行，包括方法，请求url，和HTTP版本协议
* 服务端处理HTTP请求流程
    * 服务端返回响应行，分为响应头和响应体
    * 断开连接。一般情况下一旦服务器向客户端返回了请求数据，它就要关闭TCP连接，不过如果http头里添加了connection：keep-alive，那么TCP连接将会仍然保持打开状态。`保持TCP连接可以省去下次请求时需要建立连接的时间，提升资源加载速度`。
    * 重定向。服务端通过设置http里的状态码为3xx即可告知浏览器端需要进行重定向

### 浏览器缓存

缓存是一种很有效的提升通信效率的机制。在浏览器运行的整体过程中，主要包含两种缓存，一个是DNS缓存，这个比较简单，另外一个是页面资源缓存

当服务端返回HTTP响应头给浏览器时，浏览器是通过响应头中的Cache-control字段来设置是否缓存该资源，通常我们还需要为这个资源设置一个缓存过期时长

如果缓存过期了，浏览器则会继续发起网络请求，并且在http请求头中带上一个if-None-Match字段，服务端根据该字段判断客户端缓存但过期的资源是否已经更新，如果没有更新，则返回304 Not Modified，相当于服务器告诉浏览器这个缓存可以继续使用，如果有更新则直接发送新资源

### 登录状态是如何保持的

涉及到登录的业务流程中，服务端返回的响应头中会有Set-cookie字段，然后浏览器在解析这个响应头时，解析到该字段就会将这个cookie保存到本地。之后浏览器端向服务端发送请求时都会带上cookie值

![](https://static001.geekbang.org/resource/image/1b/6c/1b49976aca2c700883d48d927f48986c.png)