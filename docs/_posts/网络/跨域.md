浏览器中有同源策略，即在一个域下的页面中，无法通过Ajax获取到其他域的接口，url的

* 协议
* 域名
* 端口

不同均可以视作跨域

应对跨域的方法有如下几种

## 1. JSONP

但是html中的几个标签可以条比同源策略，script标签，img标签和link标签，这三个标签可以加载其他域的资源，不受同源策略限制，因此引入了JSONP

> jsonp通过插入script标签的方式来实现跨域，参数只能通过url传入，仅可以支持get请求

步骤

* 创建callback方法
* 插入script标签
* 后台接受到请求，解析前端传过去的callback方法，返回该方法的调用，并且数据作为参数传入该方法
* 前台执行服务端返回的方法调用

## 2. postMessage

域名，端口，协议三者只要一个不同就会触发浏览器的同源限制，只有三个完全一样才能实现两个脚本的相互通信，`window.postMessage`方法提供了一种受控机制来规避此限制

[MDN上的postMessage](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage)

我们可以通过iframe的contentWindow属性或者window.opener属性来获取到其他窗口的句柄，然后通过postMessage来发送消息

在消息的接收方，我们可以设置事件监听器

```
window.addEventListener('message', e => {
    if(e.origin === "one-of-save-origin") {
        process(e.data)
        ...
        e.source.postMessage('Recieved', 'site-url')
    }
})
```

## 3. CORS

[阮一峰的CORS教程](http://www.ruanyifeng.com/blog/2016/04/cors.html)

Cross-Origin Resource Sharing,跨域资源共享是W3C的一个标准，它定义了在必须访问跨域资源时，浏览器和服务器该如何沟通，CORS背后的思想，就是使用自定义的http头，服务器来决定该http请求是否响应

CORS需要浏览器和服务器同时支持，对于开发者来说，CORS通信和同源的AJAX同喜没有差别，代码完全一样，浏览器一旦发现AJAX请求跨源，就会自动添加一些附加的头信息

> 实现CORS通信的关键是服务器，只要服务器实现了CORS接口，就可以跨源通信

有三个http头和CORS技术有关的字段

* Access-Control-Allow-Origin
* Access-Control-Allow-Credentials
* Access-Control-Expose-Headers

## 4. 图像Ping

利用img标签的加载资源也不收跨域的限制的特性，主要用于埋点

## 5. Comet

这是一种更加高级的Ajax技术，也叫服务器推送，Comet是一种服务器向页面推送数据的技术，它能够让数据近乎实时推送到页面中，非常适合处理体育比赛的分数和股票报价

为了简化该技术，Comet增加了两个新的接口

### SSE服务器发送事件

* 基于普通的http协议
* 服务器的单向通信

### Web Socket

Web Socket的目标是在一个单独的持久链接上提供双向通信，在js中创建了WebSocket之后，会有一个HTTP请求发送到浏览器以发起链接，在取得服务器响应之后，建立的连接会使用http协议交换为web socket协议，也就是说使用标准的http服务器无法实现Web Socket，只有支持这种协议的专门服务器才能正常工作

它使用了专门的协议，url头变为`wss://`

```
var socket = new WebSocket('wss://www.example.com/server.php')

socket.send(JSON.stringfy(obj))
socket.onmessage = e => {}
socket.onopen = ...
socket.onclose = ...
socket.close() 
```


## 总结

Ajax是无需刷新页面就可以从服务器获取数据的一种方法，负责Ajax的核心对象是XHR，最早由微软引入。同源策略是对xhr的一个主要限制。解决方案是CORS跨域资源共享，主要是在http请求头设置解除同源限制，并且在服务端做出处理，JSONP和图片Ping技术是另外两种跨域通信的技术

Comet是对Ajax的拓展，让服务器能够几乎实时和客户端推送数据，实现Comet的手段有两个，长轮询和http流。SSE是一种实现Comet交互的浏览器API，既支持长轮训，也支持http流。WebSocket是一种和服务器进行双向通信的通道，它使用独特的协议，需要服务端做出设置，这种协议专门为快速传输小数据设计，具有速度上的优势



