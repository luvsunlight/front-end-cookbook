![](https://static001.geekbang.org/resource/image/ed/66/ed4731d224da56f7b202988439575466.jpg)

## 1. 定义

如果我们在微博里发布一条带网址的信息，微博会将里面的网址转化为一个更短的网址

```
原始网址：https://github.com/wangzheng0822/ratelimiter4j
短网址：http://t.cn/EtR9QEG
```

原理大概如图

![](https://static001.geekbang.org/resource/image/1c/43/1cedb2511ec220d90d9caf71ef6c7643.jpg)

### 1.1 如何让地址变短

将任意长度的二进制数据转化为固定长度的二进制数据，这正是哈希函数的拿手好戏。我们不需要考虑反向解密，我们只需要关心计算速度和冲突概率，这样的算法有很多，最有名的就是MurmHash算法

### 1.2 如何让地址更短

我们可以更进一步让其更短，即用16进制来代替10进制

比如最开始的网址`https://github.com/wangzheng0822/ratelimiter4j`，经过MurmHash，可以变成`http://t.cn/181338494
`，再进行进制转化，`http://t.cn/cgSqq`

### 1.3 如何避免哈希冲突

一旦冲突，就会导致两个原始网址被转化为同一个短网址。这个时候我们就无法还原判断了

一般情况下，我们可以通过保存原始网址和短地址的对应关系，可以用如mySQL等数据库来存储。当一个新的原始网址需要生成短网址时，我们先利用MurmHash算法，生成短网址，然后，我们拿到这个新生成的短网址，在MySQL数据库中查找

如果没有找到，也就说明，没有冲突，于是我们将这个短网址返回给用户，并且存储之，如果找到了，我们拿出来和原网址比较，如果相同，说明这个原网址已经被请求过了，我们直接返回即可，如果不一样，我们可以对原始网址加盐之后进行哈希映射再和原始网址直接拼接特殊字符串之后的文本进行匹配，如果不行再进行这个操作，一般来说连续哈希冲突的概率是很小的

### 1.4 如何优化哈希算法生成短网址的性能

首先，我们可以给短网址字段添加B+树索引，这样就可以提升很多查询网址的速度

进一步的，我们在短网址系统生成的过程中，我们会和数据库打两次交道，也就是会执行两次SQL语句，第一个SQL语句是通过短网址查询短网址和原始网址的对应关系，第二个SQL语句是将新生成的短网址和原始网址之间的对应关系存储到数据库

实际上，这些IO操作和SQL语句的执行才是真正的性能瓶颈。我们应该尽量减少sql语句的执行

我们可以给数据库中的短网址字段，添加一个唯一索引，当有新的原始网址需要生成短网址时，我们并不会先拿生成的短网址，在数据库中判重，而是直接将生成的短网址和对应的原始网址直接尝试存储到数据库中，如果能够正常写入，则说明没有违反唯一索引，也就存在了，也就是说明，这个新生成的网址没有冲突

当然如果数据库返回异常，我们就还需要重新执行之前的操作，但是大部分情况下，效率都是提升的，除此之外，我们还可以借助布隆过滤器来帮助我们判断短网址是否存在

### 1.5 如何通过ID生成器生成短网址

我们可以维护一个ID生成器，它可以生成123遮掩搞的自增的整数ID，当短网址服务接受到一个原始网址转化成短网址的请求之后，它先从ID生成器中取一个号码，然后将其转化为62进制表示法，拼接到短网址服务的域名，最终形成了短网址

#### 1.5.1 相同的原始地址对应到不同的短网址

可以不作处理，实际上多个短网址对应到同一个原网址的事也不是不能接受。另外一种算法是哈希和查找

#### 1.5.2 如何实现高性能的ID生成器

传统的方法的话，我们需要加锁。但是性能会因此产生损耗，这里有两种思路

第一个是给ID生成器装多个前置发号器，我们接收到短网址生成请求时，就选择一个前置发号器来取号码，就能明显提升并发发号的能力

![](https://static001.geekbang.org/resource/image/8f/35/8fde8862e17b1bdf7779f2b60b166335.jpg)

第二个思路和第一个差不多，不同的是，我们同时用多个ID生成器同时服务，为了保证每个ID生成器的ID不重复，我们要求每个ID生成器按照各自的规则来生成ID号码，比如第一个ID生成器只能生成尾号为0的，以此类推

![](https://static001.geekbang.org/resource/image/bf/1a/bfeb7fc556b1fe5f9b768ce5ec90321a.jpg)

## 2. 总结

短网址服务的两种实现方法，第一种是通过哈希算法来生成短网址，哈希算法可以缩短网址的信息，然后我们可以通过进制转换进一步减少网址的长度。对于哈希算法的哈希冲突问题，我们可以通过加盐进行二次对比的方式来进一步判断网址是否存在，再进一步的优化是给短网址添加唯一索引，将两个数据库操作缩减为一个，这个才是整体性能的真正瓶颈。第二种实现思路是通过ID生成器来生成短网址，同样使用进制转换和哈希变换。多并发下的ID生成器可以用多个规则不一样的ID生成器来实现
